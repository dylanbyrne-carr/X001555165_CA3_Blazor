@page "/race/{SessionKey:int}"

<PageTitle>Race Results</PageTitle>

<div class="max-w-7xl mx-auto">
    @if (isLoading)
    {
        <div class="text-center py-20">
            <p class="text-xl">Loading race data...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="bg-red-900 border border-red-700 rounded p-4 mb-6">
            <p>@errorMessage</p>
        </div>
    }
    else
    {
        <div class="mb-6">
            <a href="/" class="text-f1-red hover:underline">Back to races</a>
        </div>

        <h2 class="text-3xl font-bold mb-2">@session?.SessionName</h2>
        <p class="text-gray-400 mb-8">@session?.CircuitShortName - @session?.CountryName</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-f1-gray rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Final Standings</h3>
                <div class="space-y-2">
                    @foreach (var result in finalStandings)
                    {
                        <div class="flex items-center gap-4 p-3 bg-f1-dark rounded">
                            <span class="text-2xl font-bold w-8">@result.Position</span>
                            <div class="w-1 h-8 rounded" style="background-color: #@result.Driver.TeamColour;"></div>
                            <div class="flex-1">
                                <p class="font-bold">@result.Driver.FullName</p>
                                <p class="text-sm text-gray-400">@result.Driver.TeamName</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="bg-f1-gray rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Lap Times</h3>
                @if (chartLaps.Any())
                {
                    <ApexChart TItem="LapChartData"
                               Title=""
                               Options="chartOptions">
                        @foreach (var driverGroup in chartLaps.GroupBy(l => l.DriverAcronym).Take(5))
                        {
                            <ApexPointSeries TItem="LapChartData"
                                             Items="driverGroup.ToList()"
                                             Name="@driverGroup.Key"
                                             SeriesType="SeriesType.Line"
                                             XValue="@(e => e.LapNumber)"
                                             YValue="@(e => (decimal)e.LapTime)" />
                        }
                    </ApexChart>
                }
                else
                {
                    <p class="text-gray-400">No lap data available</p>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int SessionKey { get; set; }

    [Inject]
    private OpenF1Service OpenF1Service { get; set; } = default!;

    private Session? session;
    private List<DriverStanding> finalStandings = new();
    private List<LapChartData> chartLaps = new();
    private bool isLoading = true;
    private string? errorMessage = null;

    private ApexChartOptions<LapChartData> chartOptions = new()
    {
        Chart = new Chart
        {
            Background = "transparent",
            Toolbar = new Toolbar { Show = false }
        },
        Theme = new Theme { Mode = Mode.Dark },
        Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
        Xaxis = new XAxis { Title = new AxisTitle { Text = "Lap" } },
        Yaxis = new List<YAxis>
        {
            new YAxis 
            { 
                Title = new AxisTitle { Text = "Lap Time (s)" },
                Labels = new YAxisLabels
                {
                    Formatter = "function(val) { return val.toFixed(1); }"
                }
            }
        },
        Grid = new Grid { BorderColor = "#38383f" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadRaceData();
    }

    private async Task LoadRaceData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            session = await OpenF1Service.GetSessionAsync(SessionKey);
            var drivers = await OpenF1Service.GetDriversAsync(SessionKey);
            var positions = await OpenF1Service.GetPositionsAsync(SessionKey);
            var laps = await OpenF1Service.GetLapsAsync(SessionKey);

            var driverDict = drivers
                .GroupBy(d => d.DriverNumber)
                .ToDictionary(g => g.Key, g => g.First());

            var lastPositions = positions
                .GroupBy(p => p.DriverNumber)
                .Select(g => g.OrderByDescending(p => p.Date).First())
                .OrderBy(p => p.CurrentPosition)
                .ToList();

            finalStandings = lastPositions
                .Where(p => driverDict.ContainsKey(p.DriverNumber))
                .Select(p => new DriverStanding
                {
                    Position = p.CurrentPosition,
                    Driver = driverDict[p.DriverNumber]
                })
                .ToList();

            chartLaps = laps
                .Where(l => l.LapDuration.HasValue && l.LapDuration > 0 && l.LapDuration < 200)
                .Where(l => !l.IsPitOutLap)
                .Where(l => driverDict.ContainsKey(l.DriverNumber))
                .Select(l => new LapChartData
                {
                    DriverNumber = l.DriverNumber,
                    DriverAcronym = driverDict[l.DriverNumber].NameAcronym,
                    LapNumber = l.LapNumber,
                    LapTime = l.LapDuration!.Value
                })
                .OrderBy(l => l.LapNumber)
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading race data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    public class DriverStanding
    {
        public int Position { get; set; }
        public Driver Driver { get; set; } = new();
    }

    public class LapChartData
    {
        public int DriverNumber { get; set; }
        public string DriverAcronym { get; set; } = string.Empty;
        public int LapNumber { get; set; }
        public double LapTime { get; set; }
    }
}